<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸»æ§ä¸“å± - å…¨ç«™é¢‘é“å‘å¸ƒä¸­å¿ƒ</title>
  <style>
    body {margin:0;padding:20px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);min-height:100vh;font-family:Arial,sans-serif;color:#fff;}
    .container {max-width:900px;margin:30px auto;padding:25px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(10px);}
    h2 {border-bottom:2px solid #4CAF50;padding-bottom:10px;margin-bottom:20px;text-align:center;}
    .publish-area {padding:20px;background:rgba(0,0,0,0.2);border-radius:10px;margin-bottom:25px;}
    input, textarea {width:100%;padding:12px;margin:8px 0;border:none;border-radius:6px;background:rgba(255,255,255,0.2);color:#fff;box-sizing:border-box;}
    textarea {min-height:100px;resize:none;}
    ::placeholder {color:rgba(255,255,255,0.7);}
    .btn {padding:12px 24px;border:none;border-radius:6px;color:#fff;cursor:pointer;margin:8px 5px;}
    .btn-success {background:#4CAF50;}
    .btn-danger {background:#f44336;}
    .btn-primary {background:#2196F3;}
    .btn-sm {padding:4px 8px;font-size:12px;border-radius:4px;margin-left:6px;}
    .post-card {padding:18px;background:rgba(255,255,255,0.1);border-radius:8px;margin:15px 0;border-left:4px solid #4CAF50;}
    .post-card h3 {margin:0 0 8px;font-size:18px;}
    .post-info {font-size:13px;opacity:0.8;margin-bottom:10px;}
    .post-content {line-height:1.7;margin:10px 0;}
    .post-op {display:flex;gap:10px;margin-top:12px;}
    .like-count {color:#ffeb3b;font-weight:bold;}
    .comment-area {margin-top:15px;padding-top:15px;border-top:1px dashed rgba(255,255,255,0.2);}
    .comment-list {margin-top:10px;max-height:180px;overflow-y:auto;}
    .comment-item {font-size:13px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:flex-start;}
    .comment-left {flex:1;}
    .comment-name {color:#4CAF50;font-weight:bold;}
    .comment-time {opacity:0.7;font-size:11px;margin-left:8px;}
    .tips {text-align:center;opacity:0.7;font-size:13px;margin-top:20px;}
  </style>
  <script src="safe.js"></script>
</head>
<body>
  <div class="container">
    <h2>ğŸ“¢ ä¸»æ§é¢‘é“ï¼ˆå‘å¸ƒåå…¨ç«™ç”¨æˆ·å³æ—¶å¯è§ï¼‰</h2>
    
    <!-- ä¸»æ§å‘å¸ƒåŒºåŸŸ -->
    <div class="publish-area">
      <h3>å‘å¸ƒå…¨ç«™é€šçŸ¥</h3>
      <input type="text" id="postTitle" placeholder="è¾“å…¥é¢‘é“æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰" class="input">
      <textarea id="postContent" placeholder="è¾“å…¥å‘å¸ƒå†…å®¹ï¼ˆå¿…å¡«ï¼‰ï¼Œå…¨ç«™ç”¨æˆ·å‡å¯æŸ¥çœ‹ã€ç‚¹èµã€è¯„è®º" class="textarea"></textarea>
      <button class="btn btn-success" onclick="publishChannel()">ç«‹å³å‘å¸ƒï¼ˆå…¨ç«™æ¨é€ï¼‰</button>
      <button class="btn btn-primary" onclick="clearPublish()">æ¸…ç©ºå†…å®¹</button>
    </div>

    <!-- å·²å‘å¸ƒå†…å®¹ç®¡ç† -->
    <h3>å·²å‘å¸ƒå†…å®¹ï¼ˆå¯åˆ é™¤+åˆ è¯„è®ºï¼‰</h3>
    <button class="btn btn-primary" onclick="refreshChannelPosts()">åˆ·æ–°æ‰€æœ‰å†…å®¹</button>
    <div id="channelList"></div>

    <p class="tips">âœ… å‘å¸ƒåè‡ªåŠ¨æ¨é€ç»™æ¸¸å®¢/æ™®é€šç”¨æˆ·ï¼ŒåŒæ­¥å‘æé†’é‚®ä»¶ | â— åˆ å¸–/åˆ è¯„è®ºåå…¨ç«™åŒæ­¥å¤±æ•ˆ | âœ¨ å…¨å‘˜å¯è¯„è®ºï¼Œä¸»æ§ç‹¬äº«åˆ è¯„æƒé™</p>
    <button class="btn btn-primary" onclick="window.location.href='master_index.html'">è¿”å›ä¸»æ§æ€»åå°</button>
  </div>

  <script>
    // ä¸»æ§æƒé™æ ¡éªŒ
    window.onload = function(){
      if(localStorage.getItem("isMaster") !== "true"){
        alert("âŒ ä»…ä¸»æ§å¯å‘å¸ƒå†…å®¹ï¼");
        window.location.href = "admin.html";
      }
    }

    // ä¸»æ§å‘å¸ƒé¢‘é“å†…å®¹
    function publishChannel() {
      const title = document.getElementById('postTitle').value.trim();
      const content = document.getElementById('postContent').value.trim();
      if(!title || !content) {alert("æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼");return;}
      const post = publishChannelPost(title, content);
      alert(`å‘å¸ƒæˆåŠŸï¼å†…å®¹IDï¼š${post.id}ï¼Œå…¨ç«™ç”¨æˆ·å·²å¯è§`);
      clearPublish();
      refreshChannelPosts();
    }

    // æ¸…ç©ºå‘å¸ƒæ¡†
    function clearPublish() {
      document.getElementById('postTitle').value = "";
      document.getElementById('postContent').value = "";
    }

    // ä¸»æ§åˆ é™¤é¢‘é“å†…å®¹
    function deleteChannelPost(postId) {
      if(!confirm("ç¡®è®¤åˆ é™¤ï¼Ÿåˆ é™¤åå…¨ç«™ç”¨æˆ·å°†æ— æ³•æŸ¥çœ‹ï¼")) return;
      channelPosts = channelPosts.filter(post => post.id !== postId);
      // åˆ å¸–åŒæ—¶åˆ å¯¹åº”æ‰€æœ‰è¯„è®º
      commentRecords = commentRecords.filter(c=>c.postId!==postId);
      alert("åˆ é™¤æˆåŠŸï¼Œå…¨ç«™åŒæ­¥æ›´æ–°ï¼ˆå«å¯¹åº”è¯„è®ºï¼‰");
      refreshChannelPosts();
      sendMasterEmail("ğŸ—‘ï¸ é¢‘é“å†…å®¹åˆ é™¤",`å†…å®¹IDï¼š${postId}\nåˆ é™¤æ—¶é—´ï¼š${new Date().toLocaleString()}\nè¿å¸¦åˆ é™¤å¯¹åº”æ‰€æœ‰è¯„è®º`);
    }

    // ä¸»æ§åˆ é™¤è¯„è®ºï¼ˆä¸“å±æƒé™ï¼‰
    function doDelComment(commentId){
      if(!confirm("ç¡®è®¤åˆ é™¤è¯¥è¯„è®ºï¼Ÿåˆ é™¤åå…¨ç«™åŒæ­¥æ¶ˆå¤±ï¼")) return;
      const res = deleteComment(commentId);
      alert(res);
      refreshChannelPosts();
    }

    // ä¸»æ§å‘è¯„è®º
    function doMasterComment(postId){
      const content = prompt("è¯·è¾“å…¥ä¸»æ§è¯„è®ºï¼ˆå…¨ç«™å¯è§ï¼‰");
      const res = publishComment(postId, "master", "master", content);
      alert(res);
      refreshChannelPosts();
    }

    // åˆ·æ–°å·²å‘å¸ƒå†…å®¹ï¼ˆä¸»æ§ä¸“å±ï¼Œå¸¦åˆ å¸–+åˆ è¯„è®ºï¼‰
    function refreshChannelPosts() {
      const list = document.getElementById('channelList');
      if(channelPosts.length === 0){
        list.innerHTML = "<p style='text-align:center;opacity:0.7;'>æš‚æ— å·²å‘å¸ƒå†…å®¹</p>";
        return;
      }
      let html = "";
      channelPosts.forEach(post => {
        const comments = getCommentsByPostId(post.id);
        let commentHtml = "<div style='opacity:0.7;font-size:13px;'>æš‚æ— è¯„è®º</div>";
        if(comments.length>0){
          commentHtml = comments.map(c=>`
            <div class="comment-item">
              <div class="comment-left">
                <span class="comment-name">${c.userRole==="master"?"ã€ä¸»æ§ã€‘":c.userRole==="normal"?"æ™®é€šç”¨æˆ·":"æ¸¸å®¢"}</span>
                <span class="comment-time">${c.time}</span>
                <div>${c.content}</div>
              </div>
              <button class="btn btn-danger btn-sm" onclick="doDelComment('${c.id}')">åˆ </button>
            </div>
          `).join("");
        }

        html += `
        <div class="post-card">
          <h3>${post.title}</h3>
          <div class="post-info">å‘å¸ƒæ—¶é—´ï¼š${post.time} | å…¨ç«™ç‚¹èµæ•°ï¼š<span class="like-count">${post.likes}</span></div>
          <div class="post-content">${post.content}</div>
          <div class="post-op">
            <button class="btn btn-danger" onclick="deleteChannelPost('${post.id}')">åˆ é™¤è¯¥å†…å®¹</button>
            <button class="btn btn-primary" onclick="likeChannelPost('${post.id}', 'master')">ä¸»æ§ç‚¹èµ</button>
            <button class="btn btn-success" onclick="doMasterComment('${post.id}')">ä¸»æ§è¯„è®º</button>
          </div>
          
          <div class="comment-area">
            <div>ğŸ’¬ å…¨ç«™è¯„è®ºåŒºï¼ˆä¸»æ§å¯åˆ é™¤ä»»æ„è¯„è®ºï¼‰</div>
            <div class="comment-list">${commentHtml}</div>
          </div>
        </div>`;
      });
      list.innerHTML = html;
    }

    // é¡µé¢åŠ è½½åˆå§‹åŒ–
    window.onload = function() {
      if(localStorage.getItem("isMaster") !== "true"){
        alert("âŒ ä»…ä¸»æ§å¯è®¿é—®ï¼");
        window.location.href = "admin.html";
        return;
      }
      refreshChannelPosts();
      // 10ç§’å®æ—¶åŒæ­¥
      setInterval(refreshChannelPosts, 10000);
    }
  </script>
</body>
</html>